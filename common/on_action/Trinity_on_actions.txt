on_game_start = {
	on_actions = {
		on_cardinal_preinitialize
		CatholicsimFix
		mapmodes
		fixing867pope
	}
}

yearly_global_pulse = {
	on_actions = {
		delay = { days = 357 }
		TCT_christmas_set
	}
}

TCT_christmas_set = {
	effect = {
		faith:catholic = {
			every_faith_ruler = {
				trigger_event = { on_action = TCT_christmas_real }
			}
		}
	}
}

TCT_christmas_real = {
	trigger = {
		is_adult = yes
	}
	random_events = {
		10000 = 0
		1 = KoH_religiousflavour.58 #Christmas! 
		#1 = bp1_yearly.3004 #Christmas, but a child!! 
		#1 = bp1_yearly.3006 # Reflecting on a great Christmas
		#1 = bp1_yearly.3006 # Last Christmas I gave you my heart
	}
}


TCT_saint_day_real = {
	trigger = {
		is_adult = yes
		#exists = var:TCT_saint_day_dummychar
	}
	events = {
		#112 = 0
		KoH_religiousflavour.63 #Saint Day! 
		#1 = bp1_yearly.3004 #Christmas, but a child!! 
		#1 = bp1_yearly.3006 # Reflecting on a great Christmas
		#1 = bp1_yearly.3006 # Last Christmas I gave you my heart
	}
}

fixing867pope = {
	trigger = {
		game_start_date = 867.1.1
	}
	effect = {
		title:k_papal_state.holder = { if = { limit = { is_lowborn = yes } title:k_papal_state.holder = { set_house = house:house_SanctiPetriFiliis } } }
		title:k_papal_state.holder = { if = { limit = { has_trait = cardinal_archbishop } remove_trait = cardinal_archbishop } }
		title:k_papal_state.holder = { if = { limit = { has_trait = cardinal_bishop } remove_trait = cardinal_bishop } }
	}
}

on_rank_down = {
	events = {
		KoH_religiousflavour.805
	}
}

on_rank_up = {
	events = {
		KoH_religiousflavour.806
	}
}

mapmodes = {
	effect = {
		set_global_variable = {
			name = custom_map_mode
			value = flag:none
		}
	}
}

CatholicsimFix = {
	effect = {
		title:k_papal_state = {
			if = {
				limit = {
					exists = holder
					has_dlc_feature = royal_court
				}
				holder = {
					set_court_language = language_latin
					if = {
						limit = { NOT = { knows_court_language_of = this } }
						learn_court_language_of = this
					}
				}
			}
		}

		every_living_character = { limit = { is_clergy = yes has_faith = faith:catholic NOT = { knows_language = language_latin } } learn_language = language_latin }
		faith:catholic = {
			add_doctrine = doctrine_independent_papacy_head
			add_doctrine = doctrine_clerical_succession_investiture_law_appointment
			remove_doctrine = doctrine_consanguinity_aunt_nephew_and_uncle_niece
			add_doctrine = doctrine_consanguinity_restricted
		}
		set_global_variable = {
			name = Trinity_is_loaded
			value = yes
		}
		title:k_papal_state.holder = {
			set_variable = was_once_cardinal
		}
	}
}

on_character_faith_change = {
	on_actions = {
		characterfaithchangeROT
	}
}

on_faith_conversion = {
	on_actions = {
		faithconversionROT
	}
}

characterfaithchangeROT = {
	effect = {
		if = {
			limit = {
				has_trait = rot_antipope
			}
			rot_remove_antipope = yes
		}
		if = {
			limit = {
				has_trait = cardinal_archbishop
			}
			remove_trait = cardinal_archbishop
			remove_cardinal = yes
			promote_new_cardinal = yes
		}
		if = {
			limit = {
				has_trait = cardinal_bishop
			}
			remove_trait = cardinal_bishop
			remove_cardinal = yes
			promote_new_cardinal = yes
		}
		if = {
			limit = {
				has_trait = cardinal_priest
			}
			remove_trait = cardinal_priest
			remove_cardinal = yes
			promote_new_cardinal = yes
		}
	}
}

faithconversionROT = {
	effect = {
		if = {
			limit = {
				has_trait = rot_antipope
			}
			rot_remove_antipope = yes
		}
		if = {
			limit = {
				has_trait = cardinal_archbishop
			}
			remove_trait = cardinal_archbishop
			remove_cardinal = yes
			promote_new_cardinal = yes
		}
		if = {
			limit = {
				has_trait = cardinal_bishop
			}
			remove_trait = cardinal_bishop
			remove_cardinal = yes
			promote_new_cardinal = yes
		}
		if = {
			limit = {
				has_trait = cardinal_priest
			}
			remove_trait = cardinal_priest
			remove_cardinal = yes
			promote_new_cardinal = yes
		}
	}
}

on_cardinal_preinitialize = {
	# Set back-end configuration data 
	effect = {
		if = { # Vanilla parameters (For testing, since I don't have AGOT)
			limit = {
				exists = faith:catholic
			}
			set_global_variable = {
				name = gui_storage
				value = religion:christianity_religion
				#value = dummy_male
			}
			set_global_variable = {
				name = the_catholic
				value = faith:catholic
			}
			set_global_variable = {
				name = insular_celts
				value = faith:insular_celtic
			}
			set_global_variable = {
				name = k_papal_state
				value = title:k_papal_state
			}
			set_global_variable = {
				name = ideal_cardinal_location
				value = title:c_roma
			}
			every_ruler = { 
				limit = { 
					has_faith = faith:catholic 
					NOT = { 
						exists = var:cardinal_player_candidate 
						has_government = mercenary_government 
						has_government = theocracy_government 
					}
					primary_title.title_held_years > 1
					is_at_war = no
					is_ruler = yes
					is_landed = yes
					is_cardinal = no
					is_pope = no
					is_alive = yes
					exists = this
				} 
				select_highest_scoring_character_cardinal_candidate = yes 
			}
		}
		global_var:the_catholic = {
			set_variable = uses_cardinal_module
		}
		global_var:insular_celts = {
			set_variable = uses_cardinal_module
		}
	}
}

on_faith_monthly = {
	on_actions = {
		delay = { months = 5 }
		NewCrusadeLeader
	}
}

NewCrusadeLeader = {
	trigger = {
		exists = religious_head
		exists = great_holy_war
		religious_head = {
			has_title = title:k_papal_state
			NOT = { exists = var:ChangedCrusadeLeader }
		}
	}
	effect = {
		if = {
			limit = {
				exists = title:d_captain_general_church.holder
			}
			debug_log = "Testing Crusade Change Leader"
			title:k_papal_state.holder = {
				pledge_ghw_piety_gain_effect = yes
			}
		}
		else_if = {
			limit = {
				NOT = { exists = title:d_captain_general_church.holder }
				title:k_papal_state.holder = {
					has_title = title:c_tivoli
				}
			}
			title:k_papal_state.holder = {
				create_character = {
					location = title:k_papal_state.holder.capital_province
					age = { 25 35 }
					gender = male
					trait = education_martial_4
					trait = devoted
					faith = title:k_papal_state.holder.faith
					culture = title:k_papal_state.holder.culture
					learning = { 10 12 }
					save_scope_as = CrusaderLeader
				}
			}
			create_title_and_vassal_change = {
				type = created
				save_scope_as = title_change
				add_claim_on_loss = no
			}
			title:d_captain_general_church = {
				change_title_holder = {
					holder = scope:CrusaderLeader
					change = scope:title_change
				}
			}
			resolve_title_and_vassal_change = scope:title_change
			title:d_captain_general_church.holder = {
				change_government = mercenary_government_mod
			}
			title:d_captain_general_church = {
				add_title_law = mercenary_company_mod_succession_law
			}
			debug_log = "Testing Crusade Change Leader"
			title:k_papal_state.holder = {
				pledge_ghw_piety_gain_effect = yes
			}
		}
	}
}

on_game_start_after_lobby = {
	on_actions = {
		on_cardinal_initialize
		CardinalsTraits
		captianchurch
		HREInvestiture
	}
}

HREInvestiture = {
	trigger = {
		current_date >= 1059.1.1
		exists = title:k_papal_state.holder
		exists = title:e_hre.holder
	}
	effect = {
		title:e_hre.holder = {
			add_realm_law_skip_effects = free_investiture_early
		}
	}
}

on_great_holy_war_countdown_end = {
	effect = {
		if = {
			limit = {
				exists = religious_head
				religious_head = {
					has_title = title:k_papal_state
				}
				exists = title:d_captain_general_church.holder
			}
			title:d_captain_general_church.holder = {
				save_scope_as = ghw_sponsor
			}
			faith = {
				great_holy_war = {
					set_war_declarer = scope:ghw_sponsor
					if = {
						limit = {
							NOT = { has_pledged_attacker = scope:ghw_sponsor }
						}
						pledge_attacker = scope:ghw_sponsor
					}
				}
			}
		}
	}
}

captianchurch = {
	effect = {
		if = {
			limit = {
				exists = title:d_captain_general_church.holder
			}
			title:d_captain_general_church.holder = {
				get_title = title:c_tivoli

				create_title_and_vassal_change = {
					type = granted #or whatever
					save_scope_as = change
				}
				
				change_liege = {
					liege = title:k_papal_state.holder
					change = scope:change
				}
				resolve_title_and_vassal_change = scope:change
				add_realm_law = mercenary_company_mod_succession_law
			}
		}
	}
}

CardinalsTraits = {
	effect = {
		title:k_papal_state.holder = {
			trigger_event = KoH_religiousflavour.22
			update_cardinal_window = yes
		}
		if = {
			limit = {
				title:k_papal_state.holder = {
					faith = {
						NOT = {
							has_doctrine = doctrine_spiritual_head
						}
					}
				}	
			}
			title:k_papal_state.holder = {
				faith = {
					add_doctrine = doctrine_spiritual_head
				}
			}
		}
	}
	on_actions = {
		delay = { months = 1 }
		CardinalsTraits
	}
}

on_title_gain = {
	on_actions = {
		on_gain_papacy
		on_gain_cardinal
		delay = { days = { 2 4 } }		
		priests_learn_latin
	}
}
on_gain_cardinal = {
	trigger = {
		CatholicTrinityCardinalTrigger = yes
	}
	effect = {
		if = {
			limit = {
				has_nickname = nick_cardinal
			}
			remove_nickname = yes
		}
	}
}
on_cardinal_initialize = {
	effect = {
		debug_log = "initializing cardinals"
		initialize_random_cardinals = yes
		update_preferatus = yes
		update_cardinal_window = yes
	}
}

on_death = {
    on_actions = {
		on_antipope_death
        on_cardinal_death
        on_pope_death
        on_person_death_saint
		on_theocrat_investiture_death
		on_preferatus_death
    }
}

on_antipope_death = {
	trigger = {
		has_trait = rot_antipope
	}
	effect = {
		rot_remove_antipope = yes
		add_trait = pope_trait
		add_trait = rot_antipope
		give_nickname = nick_pope
	}
}

on_theocrat_investiture_death = {
	trigger = {
		exists = primary_title
		primary_title = {
			has_variable = theocratic_successor
		}
	}
	effect = {
		liege = { save_scope_as = important_liege }
		primary_title = { var:theocratic_successor = { save_scope_as = theocratic_inheritor } remove_variable = theocratic_successor }
		create_title_and_vassal_change = {
			type = granted
			save_scope_as = title_change
			add_claim_on_loss = no
		}
		every_held_title = {
			change_title_holder = {
				holder = scope:theocratic_inheritor
				change = scope:title_change
			}
		}
		resolve_title_and_vassal_change = scope:title_change
		scope:theocratic_inheritor = {
			remove_variable = theocratic_successor
			change_government = theocracy_government
			create_title_and_vassal_change = {
				type = swear_fealty
				save_scope_as = change
			}
			change_liege = {
				liege = scope:important_liege
				change = scope:change
			}
			resolve_title_and_vassal_change = scope:change
		}
	}
}

on_person_death_saint = {
    events = {
        KoH_sainthood.1
    }
}

pilgrimage_destination_events = {
	first_valid_on_action = {
		hajj_destination_events
		christian_destination_events
		jewish_destination_events
		muslim_destination_events
		hindu_destination_events
		buddhist_destination_events
		jain_destination_events
		zoroastrian_destination_events
		norse_destination_events
		tengri_destination_events
		pagan_destination_events
		#saintly_tomb_destination_events
		pilgrimage_generic_destination_events

	}
}

on_cardinal_death = {
	trigger = {
		owns_story_of_type = cardinal_story
	}
	effect = {
		save_scope_as = dyingcardinal
		give_nickname = nick_cardinal
		update_cardinal_window = yes
		update_preferatus = yes

		title:k_papal_state.holder = {
			send_interface_message = {
				type = event_generic_bad_text
				title = cardinaldied
				desc = cardinaldied_desc
		
				left_icon = root
			}
		}
	}
}

on_preferatus_death = {
	trigger = {
		AND = {
			has_cardinal_faith = yes
			OR = {
				has_trait = cardinal_priest
				has_trait = cardinal_bishop
				has_trait = cardinal_archbishop
			}
			exists = global_var:preferatus
			this = global_var:preferatus.story_owner
			any_owned_story = {
				story_type = cardinal_story
			}
		}
	}
	effect = {
		update_cardinal_window = yes
		global_var:preferatus = {
			promote_new_cardinal = yes
			update_cardinal_window = yes
		}
		title:k_papal_state.holder = {
			trigger_event = KoH_religiousflavour.801
		}
	}
}

on_pope_death = {
	trigger = {
		has_title = title:k_papal_state
	}
	effect = {
		if = {
			limit = {
				game_start_date = 1066.9.15
				exists = character:2010
				character:2010 = {
					is_alive = yes
				}
				NOT = { 
					character:2010 = title:k_papal_state.holder
					exists = global_var:TCT_Pope_Gregory_VII 
				}
			}
			set_global_variable = TCT_Pope_Gregory_VII
			save_scope_as = deadpope

			create_character = {
				location = scope:deadpope.capital_province
				age = { 30 33 }
				gender = male
				trait = education_learning_3
				trait = devoted
				faith = scope:deadpope.faith
				culture = scope:deadpope.culture
				learning = { 10 12 }
				save_scope_as = monk
			}

			#Value Management
			if = {
				limit = {
					exists = cp:councillor_marshal
				}
				cp:councillor_marshal = {
					save_scope_as = marshal
				}
			}
			if = {
				limit = {
					exists = cp:councillor_chancellor
				}
				cp:councillor_chancellor = {
					save_scope_as = chancellor
				}
			}
			if = {
				limit = {
					exists = cp:councillor_steward
				}
				cp:councillor_steward = {
					save_scope_as = steward
				}
			}
			if = {
				limit = {
					exists = cp:councillor_spymaster
				}
				cp:councillor_spymaster = {
					save_scope_as = spymaster
				}
			}

			update_preferatus = yes
			# Preferatus, doesn't matter here, Pope Gregory VII Time!
			# global_var:preferatus.story_owner = { depose = yes }
			# global_var:preferatus.story_owner = {
			# 	save_scope_as = preferatus 
			# }
			character:2010 = {
				set_variable = was_once_cardinal
				save_scope_as = preferatus
				add_prestige = 3000
				add_piety = 3000
			}
			create_title_and_vassal_change = {
				type = election
				save_scope_as = papal_inheritance
			}
			# Transfer every non-barony title
			every_held_title = {
				limit = {
					tier > tier_barony
				}
				every_player = {
					add_prestige = 1
				}
				change_title_holder = {
					holder = character:2010
					change = scope:papal_inheritance
				}
			}
			set_player_character = scope:preferatus
			# title:k_papal_state = {
			# 	change_title_holder = {
			# 		holder = global_var:preferatus.story_owner
			# 		change = scope:papal_inheritance
			# 	}
			# }
			resolve_title_and_vassal_change = scope:papal_inheritance

			character:2010 = {
				set_realm_capital = title:c_roma
			}

			# global_var:preferatus = {
			# 	promote_new_cardinal = yes
			# }
			
			scope:preferatus = {
				set_player_character = scope:monk
			}

			scope:monk = {
				set_player_character = scope:preferatus
			}
			update_cardinal_window = yes
			update_preferatus = yes

			title:k_papal_state.holder = {	
				add_gold = scope:deadpope.gold

				create_character = {
					location = scope:deadpope.capital_province
					faith = scope:deadpope.faith
					culture = scope:deadpope.culture
					learning = { 10 12 }
					save_scope_as = duplicatename
					after_creation = {
						change_first_name = { template_character = title:k_papal_state.holder }
					}
				}

				set_variable = {
					name = duplicatenameexists
					value = scope:duplicatename
				}

				if = {
					limit = {
						NOT = { exists = cp:councillor_marshal }
						exists = scope:marshal
					}
					assign_councillor_type = {
						type = councillor_marshal
						target = scope:marshal
					}
				}
				if = {
					limit = {
						NOT = { exists = cp:councillor_steward }
						exists = scope:steward
					}
					assign_councillor_type = {
						type = councillor_steward
						target = scope:steward
					}
				}
				if = {
					limit = {
						NOT = { exists = cp:councillor_chancellor }
						exists = scope:chancellor
					}
					assign_councillor_type = {
						type = councillor_chancellor
						target = scope:chancellor
					}
				}
				if = {
					limit = {
						NOT = { exists = cp:councillor_spymaster }
						exists = scope:spymaster
					}
					assign_councillor_type = {
						type = councillor_spymaster
						target = scope:spymaster
					}
				}
				title:k_papal_state.holder = { 
					trigger_event = KoH_religiousflavour.400
				}
			}

			scope:deadpope = {
				add_trait = pope_trait
				give_nickname = nick_pope

				every_character_artifact = {
					set_owner = title:k_papal_state.holder
				}
			}
		}
		else = {
			save_scope_as = deadpope
		
			create_character = {
				location = scope:deadpope.capital_province
				age = { 30 33 }
				gender = male
				trait = education_learning_3
				trait = devoted
				faith = scope:deadpope.faith
				culture = scope:deadpope.culture
				learning = { 10 12 }
				save_scope_as = monk
			}

			#Value Management
			if = {
				limit = {
					exists = cp:councillor_marshal
				}
				cp:councillor_marshal = {
					save_scope_as = marshal
				}
			}
			if = {
				limit = {
					exists = cp:councillor_chancellor
				}
				cp:councillor_chancellor = {
					save_scope_as = chancellor
				}
			}
			if = {
				limit = {
					exists = cp:councillor_steward
				}
				cp:councillor_steward = {
					save_scope_as = steward
				}
			}
			if = {
				limit = {
					exists = cp:councillor_spymaster
				}
				cp:councillor_spymaster = {
					save_scope_as = spymaster
				}
			}

			update_preferatus = yes
			global_var:preferatus.story_owner = { depose = yes }
			global_var:preferatus.story_owner = {
				save_scope_as = preferatus 
			}
			create_title_and_vassal_change = {
				type = election
				save_scope_as = papal_inheritance
			}
			# Transfer every non-barony title
			every_held_title = {
				limit = {
					tier > tier_barony
				}
				every_player = {
					add_prestige = 1
				}
				change_title_holder = {
					holder = global_var:preferatus.story_owner
					change = scope:papal_inheritance
				}
			}
			set_player_character = scope:preferatus
			# title:k_papal_state = {
			# 	change_title_holder = {
			# 		holder = global_var:preferatus.story_owner
			# 		change = scope:papal_inheritance
			# 	}
			# }
			resolve_title_and_vassal_change = scope:papal_inheritance

			global_var:preferatus.story_owner = {
				set_realm_capital = title:c_roma
			}

			global_var:preferatus = {
				promote_new_cardinal = yes
			}
			
			scope:preferatus = {
				set_player_character = scope:monk
			}

			scope:monk = {
				set_player_character = scope:preferatus
			}
			update_cardinal_window = yes
			update_preferatus = yes

			title:k_papal_state.holder = {	
				add_gold = scope:deadpope.gold

				create_character = {
					location = scope:deadpope.capital_province
					faith = scope:deadpope.faith
					culture = scope:deadpope.culture
					learning = { 10 12 }
					save_scope_as = duplicatename
					after_creation = {
						change_first_name = { template_character = title:k_papal_state.holder }
					}
				}

				set_variable = {
					name = duplicatenameexists
					value = scope:duplicatename
				}

				if = {
					limit = {
						NOT = { exists = cp:councillor_marshal }
						exists = scope:marshal
					}
					assign_councillor_type = {
						type = councillor_marshal
						target = scope:marshal
					}
				}
				if = {
					limit = {
						NOT = { exists = cp:councillor_steward }
						exists = scope:steward
					}
					assign_councillor_type = {
						type = councillor_steward
						target = scope:steward
					}
				}
				if = {
					limit = {
						NOT = { exists = cp:councillor_chancellor }
						exists = scope:chancellor
					}
					assign_councillor_type = {
						type = councillor_chancellor
						target = scope:chancellor
					}
				}
				if = {
					limit = {
						NOT = { exists = cp:councillor_spymaster }
						exists = scope:spymaster
					}
					assign_councillor_type = {
						type = councillor_spymaster
						target = scope:spymaster
					}
				}
				title:k_papal_state.holder = { 
					trigger_event = KoH_religiousflavour.400
				}
			} 

			scope:deadpope = {
				add_trait = pope_trait
				give_nickname = nick_pope

				every_character_artifact = {
					set_owner = title:k_papal_state.holder
				}
			}
		}
	}
}

on_gain_papacy = {
	trigger = {
		scope:title = title:k_papal_state
	}
	effect = {
		add_trait = pope_trait
		if = { limit = { is_lowborn = yes } title:k_papal_state.holder = { set_house = house:house_SanctiPetriFiliis } }
		if = { limit = { has_trait = cardinal_bishop } remove_trait = cardinal_bishop }
		if = { limit = { has_trait = cardinal_priest } remove_trait = cardinal_priest }
		if = { limit = { has_trait = cardinal_archbishop } remove_trait = cardinal_archbishop }
		every_player = {add_gold = 1}
		if = {limit = {is_cardinal = yes} every_player = {add_piety = 1}}
		if = { limit = { has_trait = rot_antipope } rot_remove_antipope = yes}
	}
}

on_war_started = {
	on_actions = {
		Trinity_on_war_started
	}
}

Trinity_on_war_started = {
	effect = {
		if = {
			limit = {
				exists = title:k_papal_state.holder
				scope:attacker = {
					has_faith = faith:catholic
					NOT = { has_government = theocracy_government }
				}
				
				scope:defender = {
					has_faith = faith:catholic
					has_government = theocracy_government
				}
			}
			scope:defender = {
				save_scope_as = BishopyDefender
			}
			title:k_papal_state.holder = {
				trigger_event = {
					id = KoH_religiousflavour.56
					days = 3
				}
			}
		}
	}
}

#Priests learn latin!
on_title_gain_inheritance = {
	on_actions = {
		delay = { days = { 2 4 } }		
		priests_learn_latin
	}
}

on_title_gain_usurpation = {
	on_actions = {
		delay = { days = { 2 4 } }		
		priests_learn_latin
	}
}

on_baron_found_or_created_for_title = {
	on_actions = {
		delay = { days = { 2 4 } }		
		priests_learn_latin
	}
}


priests_learn_latin = {
	effect = {	
		if = {
			limit = {
				is_clergy = yes
				has_faith = faith:catholic
				learning > average_skill_rating #8
				NOT = { knows_language = language_latin }
			}
			learn_language = language_latin
		}
	}
}

on_faith_created = {
	events = {
		KoH_religiousflavour.807
	}
}