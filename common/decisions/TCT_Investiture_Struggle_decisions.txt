tct_investiture_struggle_switch_sides_decision = {
	picture = "gfx/interface/illustrations/decisions/fp3/antagonistic.dds"
	selection_tooltip = tct_investiture_struggle_switch_sides_decision_tooltip 
	major = yes 
	sort_order = -20
	# We check this via the struggle itself.
	ai_check_interval = 0

	title = {
		first_valid = {
			# Supporter turns Detractor.
			triggered_desc = {
				trigger = { has_trait = tct_imperial_supporter }
				desc = tct_investiture_struggle_switch_sides_decision.supporter_turns_detractor.t
			}
			# Detractor turns Supporter.
			triggered_desc = {
				trigger = { has_trait = tct_papal_supporter }
				desc = tct_investiture_struggle_switch_sides_decision.detractor.turns_supporter.t
			}
			# Neither trait.
			desc = tct_investiture_struggle_switch_sides_decision.neutral.t
		}
	}

	desc = {
		first_valid = {
			# Supporter turns Detractor.
			triggered_desc = {
				trigger = { has_trait = tct_imperial_supporter }
				desc = tct_investiture_struggle_switch_sides_decision.supporter_turns_detractor.desc
			}
			# Detractor turns Supporter.
			triggered_desc = {
				trigger = { has_trait = tct_papal_supporter }
				desc = tct_investiture_struggle_switch_sides_decision.detractor.turns_supporter.desc
			}
			# Neither trait.
			desc = tct_investiture_struggle_switch_sides_decision.neutral.desc
		}
	}

	is_shown = {
		any_character_struggle = { this = struggle:investiture_controversy_struggle }
		has_religion = religion:christianity_religion
	}

	is_valid = {
		OR = {
			tct_investiture_struggle_switch_sides_decision_liege_requirements_trigger = yes
			trigger_if = {
				# If you meet the requirements, there'll be no warning copy as it just doesn't apply to you.
				limit = { tct_investiture_struggle_switch_sides_decision_liege_requirements_trigger = no }
				custom_tooltip = {
					text = tct_investiture_struggle_switch_sides_decision.tt.fallback_validity
					always = yes
				}
			}
		}
		is_at_war = no
		# Supporters can't switch away to detraction if they're allied to the Holy Roman Emperor.
		trigger_if = {
			limit = {
				has_trait = tct_imperial_supporter
				exists = title:e_hre.holder
			}
			NOT = { is_allied_to = title:e_hre.holder }
		}
		NOT = { this = title:e_hre.holder }
	}

	is_valid_showing_failures_only = {
		is_available_adult = yes
		# custom_tooltip = {
		# 	text = tct_investiture_struggle_switch_sides_decision.tt.orthodox_sunnis_only
		# 	has_religion = religion:islam_religion
		# 	faith.religious_head ?= title:e_hre.holder
		# }
		custom_tooltip = {
			text = tct_investiture_struggle_switch_sides_decision.tt.hre_emperor_must_exist
			exists = title:e_hre.holder
		}
		custom_tooltip = {
			text = tct_investiture_struggle_switch_sides_decision.tt.hre_emperor_cannot_change_prayer_order
			NOT = { has_title = title:e_hre }
		}
		# If you've already got the modifier, then you can't flipflop unless the emperor changes.
		trigger_if = {
			limit = {
				has_variable = switch_sides_decision_emperor
				title:e_hre.holder ?= var:switch_sides_decision_emperor
				OR = {
					has_character_modifier = tct_investiture_struggle_modifier
					has_character_modifier = fp3_displayed_pious_submission_to_emperor_modifier
				}
			}
			custom_tooltip = {
				text = tct_investiture_struggle_switch_sides_decision.tt.require_new_emperor_or_modifier_lapse
				always = no
			}
		}
		# If you rejected the emperor's demands previously, then you can't flipflop unless the emperor changes.
		custom_tooltip = {
			text = tct_investiture_struggle_switch_sides_decision.tt.require_new_emperor_or_flag_lapse
			OR = {
				NOT = { has_variable = last_explicit_defied_emperor }
				NOT = { title:e_hre.holder ?= var:last_explicit_defied_emperor }
			}
		}
		# If you killed the Emperor at any point, you can't switch at all.
		trigger_if = {
			limit = {
				has_trait = tct_papal_supporter
				exists = title:e_hre.holder
				exists = title:e_hre.holder.dynasty
				NOT = { dynasty ?= title:e_hre.holder.dynasty }
			}
			custom_tooltip = {
				text = tct_investiture_struggle_switch_sides_decision.tt.emperor_murderers_cant_become_supporters
				NOT = {
					any_killed_character = {
						save_temporary_scope_as = char_temp
						title:e_hre = {
							any_past_holder = { this = scope:char_temp }
						}
					}
				}
			}
		}
	}

	cost = {
		piety = {
			# Base value.
			value = 250
			# Not meeting the liege trigger reqs gives you an extra surcharge.
			if = {
				limit = { tct_investiture_struggle_switch_sides_decision_liege_requirements_trigger = no }
				add = 350
			}
		}
	}

	effect = {
		show_as_tooltip = { investiture_controversy_struggle_switch_sides_scripted_effect = yes }
		trigger_event = tct_investiture_struggle.0015
	}
		

	# No AI checks here as we handle them taking the decision as part of general struggle stuff.
}